/*
  JS for dashboard functionality
  Author: Ethan Nguyen
  Description: Query user's device history from database and display them on graphs using
    google charts
  Note: ChatGPT was used for a large portion of the google chart functionalites.
    Such as formatting, designing and displaying proper data on graphs.
*/

// Parse JSON objects from database and pass them to graph functions
document.addEventListener("DOMContentLoaded", async function () {
  try {
    const response = await fetch('/dashboardDevices');
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    const json = await response.text();

    userDevicesHistory = JSON.parse(json);

    // Check and duplicate device history for missing dates
    checkAndDuplicateDeviceHistory();

    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(() => {
      drawPieChart(userDevicesHistory);
      drawBarGraph(userDevicesHistory, 'week'); // Default to weekly
    });

    // Trigger click event on "Week" links
    document.getElementById('pie-week-link').click();
    document.getElementById('bar-week-link').click();
  } catch (error) {
    console.error('Error loading devices:', error);
  }
});

const period = document.querySelectorAll('a');

// Convert NodeList to an array and select only the first 3 elements
const firstThreeLinks = Array.from(period).slice(0, 3);

firstThreeLinks.forEach(time => {
  time.addEventListener('click', (event) => {
    event.preventDefault();
    firstThreeLinks.forEach(t => t.className = 'nav-link text-success');
    time.className = 'nav-link active text-success';
    filterData(time.textContent.toLowerCase(), 'pie');
  });
});

// Convert NodeList to an array and select only the last 3 elements
const secondsThreeLinks = Array.from(period).slice(3, 6);

secondsThreeLinks.forEach(time => {
  time.addEventListener('click', (event) => {
    event.preventDefault();
    secondsThreeLinks.forEach(t => t.className = 'nav-link text-success');
    time.className = 'nav-link active text-success';
    filterData(time.textContent.toLowerCase(), 'bar');
  });
});

// Array of all the user's device history
let userDevicesHistory = [];

/* 
  If a user does not input/edit any new devices for the day, this will autofill
  the missing dates with the most recent log.
*/
function checkAndDuplicateDeviceHistory() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  if (userDevicesHistory.length === 0) return;

  // Find the latest entry
  let latestEntry = userDevicesHistory[userDevicesHistory.length - 1];
  let latestDate = new Date(latestEntry.date);
  latestDate.setHours(0, 0, 0, 0);

  // Adds missing device logs with latest date
  while (latestDate < today) {
    latestDate.setDate(latestDate.getDate() + 1);
    const newEntry = {
      date: latestDate.toISOString(),
      user_devices: JSON.parse(JSON.stringify(latestEntry.user_devices))
    };
    userDevicesHistory.push(newEntry);
  }
}

// Filter data based on time period
function filterData(period, chartType) {
  const now = new Date();
  let filteredData = [];

  // Finds the devices from a week a go
  if (period === 'week') {
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    filteredData = userDevicesHistory.filter(entry => {
      const entryDate = new Date(entry.date);
      return entryDate >= weekAgo;
    });
  
  // Finds the devices from a month a go
  } else if (period === 'month') {
    const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
    filteredData = userDevicesHistory.filter(entry => {
      const entryDate = new Date(entry.date);
      return entryDate >= monthAgo;
    });
  
  // Finds the devices from a year a go
  } else if (period === 'year') {
    const yearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
    filteredData = userDevicesHistory.filter(entry => {
      const entryDate = new Date(entry.date);
      return entryDate >= yearAgo;
    });
  }

  if (chartType === 'pie') {
    drawPieChart(filteredData);
  } else if (chartType === 'bar') {
    drawBarGraph(filteredData, period);
  }
}

/* 
  Utilizes Google Charts open-source pie chart to display visuals on ejs file
  Note: This section was generated by ChatGPT
*/
function drawPieChart(filteredData) {
  if (!filteredData.length) {
    console.error('No devices data available');
    return;
  }

  const dataArray = [['Device', 'kWh']];
  const deviceTotals = {};

  filteredData.forEach(entry => {
    entry.user_devices.forEach(device => {
      deviceTotals[device.name] = (deviceTotals[device.name] || 0) + parseFloat(device.kWh);
    });
  });

  for (const [name, kWh] of Object.entries(deviceTotals)) {
    dataArray.push([name, kWh]);
  }

  const data = google.visualization.arrayToDataTable(dataArray);

  const colors = generateColors(Object.keys(deviceTotals).length);

  const options = {
    title: 'Energy Consumption per Device',
    legend: { position: 'none' },
    width: '100%',
    height: 400,
    colors: colors
  };

  const chart = new google.visualization.PieChart(document.getElementById('piechart'));
  google.visualization.events.addListener(chart, 'ready', () => {
    createCustomLegend(deviceTotals, colors);
  });
  chart.draw(data, options);
}

// Generates custom colors so that they can match the legend later
function generateColors(numberOfColors) {
  const colors = [];
  const baseColors = ['#76A7FA', '#FF6347', '#FFD700', '#ADFF2F', '#32CD32', '#FF4500', '#8A2BE2', '#FF1493', '#00CED1', '#20B2AA'];
  for (let i = 0; i < numberOfColors; i++) {
    colors.push(baseColors[i % baseColors.length]);
  }
  return colors;
}

/*
  Custom legend from highest kWh device to lowest with matching colors to pie chart
  Note: Help from ChatGPT to match colors with Google Chart Pie Chart
*/
function createCustomLegend(deviceTotals, colors) {
  const devicesWithColors = [];

  let index = 0;
  for (const [name, kWh] of Object.entries(deviceTotals)) {
    devicesWithColors.push({
      name: name,
      kWh: kWh,
      color: colors[index]
    });
    index++;
  }

  devicesWithColors.sort((a, b) => b.kWh - a.kWh);

  const midpoint = Math.ceil(devicesWithColors.length / 2);
  const leftColumn = devicesWithColors.slice(0, midpoint);
  const rightColumn = devicesWithColors.slice(midpoint);

  let legendHtml = '<div style="display: flex; justify-content: center;">';
  legendHtml += '<ul style="list-style: none; padding: 0; margin: 0 20px;">';
  leftColumn.forEach(device => {
    const deviceName = device.name.charAt(0).toUpperCase() + device.name.slice(1);
    legendHtml += `<li><span style="display: inline-block; width: 10px; height: 10px; background-color: ${device.color}; margin-right: 8px;"></span>${deviceName}</li>`;
  });
  legendHtml += '</ul>';

  legendHtml += '<ul style="list-style: none; padding: 0; margin: 0 20px;">';
  rightColumn.forEach(device => {
    const deviceName = device.name.charAt(0).toUpperCase() + device.name.slice(1);
    legendHtml += `<li><span style="display: inline-block; width: 10px; height: 10px; background-color: ${device.color}; margin-right: 8px;"></span>${deviceName}</li>`;
  });
  legendHtml += '</ul>';
  legendHtml += '</div>';

  const legendDiv = document.getElementById('piechart-legend');
  legendDiv.innerHTML = legendHtml;
}

/*
  Draws the bar graph depending on the time period selected
  Note: This section was heavily reliant on ChatGPT
*/
function drawBarGraph(filteredData, period) {
  if (!filteredData.length) {
    console.error('No devices data available');
    return;
  }

  let dataArray = [["Date", "kWh", { role: "style" }, "CO2e (kg)", { role: "style" }]];

  if (period === 'week') {
    const dailyData = {};

    // Initialize dailyData for the past 7 days
    for (let i = 0; i < 7; i++) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateString = date.toISOString().split('T')[0];
      dailyData[dateString] = { kWh: 0, CO2e: 0 };
    }

    // Format Date object
    filteredData.forEach(entry => {
      const entryDate = new Date(entry.date).toISOString().split('T')[0];
      if (dailyData[entryDate]) {
        entry.user_devices.forEach(device => {
          const kWh = parseFloat(device.kWh);
          dailyData[entryDate].kWh += kWh;
          dailyData[entryDate].CO2e += (kWh * 127.82) / 1000;
        });
      }
    });

    const sortedDailyData = Object.entries(dailyData).sort((a, b) => new Date(a[0]) - new Date(b[0]));

    for (const [date, data] of sortedDailyData) {
      dataArray.push([date, data.kWh, "color: #76A7FA", data.CO2e, "color: #FF6347"]);
    }
  } else if (period === 'month') {
    const weeklyData = {};

    // Initialize weeklyData for the past 4 weeks
    for (let i = 0; i < 4; i++) {
      const weekStart = new Date();
      weekStart.setDate(weekStart.getDate() - i * 7);
      const weekString = `Week ${4 - i}`;
      weeklyData[weekString] = { kWh: 0, CO2e: 0 };
    }

    filteredData.forEach(entry => {
      const entryDate = new Date(entry.date);
      const weekIndex = Math.floor((Date.now() - entryDate) / (7 * 24 * 60 * 60 * 1000));
      if (weekIndex < 4) {
        const weekString = `Week ${4 - weekIndex}`;
        entry.user_devices.forEach(device => {
          const kWh = parseFloat(device.kWh);
          weeklyData[weekString].kWh += kWh;
          weeklyData[weekString].CO2e += (kWh * 127.82) / 1000;
        });
      }
    });

    const sortedWeeklyData = Object.entries(weeklyData).sort((a, b) => a[0].localeCompare(b[0]));

    for (const [week, data] of sortedWeeklyData) {
      dataArray.push([week, data.kWh, "color: #76A7FA", data.CO2e, "color: #FF6347"]);
    }
  } else if (period === 'year') {
    const monthlyData = {};

    // Initialize monthlyData for the past 12 months
    for (let i = 0; i < 12; i++) {
      const date = new Date();
      date.setMonth(date.getMonth() - i);
      const dateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
      monthlyData[dateString] = { kWh: 0, CO2e: 0 };
    }

    filteredData.forEach(entry => {
      const entryDate = new Date(entry.date);
      const entryMonth = `${entryDate.getFullYear()}-${(entryDate.getMonth() + 1).toString().padStart(2, '0')}`;
      if (monthlyData[entryMonth]) {
        entry.user_devices.forEach(device => {
          const kWh = parseFloat(device.kWh);
          monthlyData[entryMonth].kWh += kWh;
          monthlyData[entryMonth].CO2e += (kWh * 127.82) / 1000;
        });
      }
    });

    const sortedMonthlyData = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));

    for (const [month, data] of sortedMonthlyData) {
      dataArray.push([month, data.kWh, "color: #76A7FA", data.CO2e, "color: #FF6347"]);
    }
  }

  const data = google.visualization.arrayToDataTable(dataArray);

  const view = new google.visualization.DataView(data);
  view.setColumns([0, 1, 2, 3, 4]);

  const options = {
    title: period === 'week' ? "Daily Energy Consumption and CO2e for the Past Week" :
           period === 'month' ? "Weekly Energy Consumption and CO2e for the Past Month" :
           "Monthly Energy Consumption and CO2e for the Past Year",
    width: "100%",
    height: 400,
    bar: { groupWidth: "80%" },
    legend: { position: "none" },
    hAxis: {
      textStyle: { fontSize: 10 } // Adjust font size to fit longer labels if necessary
    },
    series: {
      0: { color: '#76A7FA' },
      1: { color: '#FF6347' }
    }
  };

  const chart = new google.visualization.ColumnChart(document.getElementById("columnchart_values"));
  google.visualization.events.addListener(chart, 'ready', () => {
    createBarChartLegend();
  });
  chart.draw(view, options);
}

// Small legend to show which bar is kWh and CO2e
function createBarChartLegend() {
  const legendHtml = `
    <div style="display: flex; justify-content: center;">
      <ul style="list-style: none; padding: 0; margin: 0 20px;">
        <li><span style="display: inline-block; width: 10px; height: 10px; background-color: #76A7FA; margin-right: 8px;"></span>kWh</li>
        <li><span style="display: inline-block; width: 10px; height: 10px; background-color: #FF6347; margin-right: 8px;"></span>CO2e (kg)</li>
      </ul>
    </div>`;
  
  const legendDiv = document.getElementById('barchart-legend');
  legendDiv.innerHTML = legendHtml;
}
